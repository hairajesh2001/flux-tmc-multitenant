apiVersion: v1
kind: Secret
metadata:
  name: fluent-bit-package-values
  namespace: default
stringData:
  fluent-bit-data-values.yml: |-
    namespace: "tanzu-system-logging"
    fluent_bit:
      config:
        service: |-
          [Service]
            Flush         1
            Log_Level     info
            Daemon        off
            Parsers_File  parsers.conf
            HTTP_Server   On
            HTTP_Listen   0.0.0.0
            HTTP_Port     2020
        outputs: |
          [OUTPUT]
            Name   syslog
            Match  infra.*
            Host   nploginsight.warroyo.com
            Port   514
            Mode   udp
            Syslog_Format        rfc5424
            Syslog_Hostname_key  clustername
            Syslog_Appname_key   pod_name
            Syslog_Procid_key    container_name
            Syslog_Message_key   message
            Syslog_SD_key        kubernetes
            Syslog_SD_key        labels
            Syslog_SD_key        annotations
          [OUTPUT]
            Name   syslog
            Match  kube_systemd.*
            Host   nploginsight.warroyo.com
            Port   514
            Mode   udp
            Syslog_Format        rfc5424
            Syslog_Hostname_key  clustername
            Syslog_Appname_key   COMM
            Syslog_Procid_key    hostname
            Syslog_Message_key   MESSAGE
            Syslog_facility_key  SYSLOG_FACILITY
            Syslog_severity_key  PRIORITY
          [OUTPUT]
            Name   syslog
            Match  kube_audit.*
            Host   nploginsight.warroyo.com
            Port   514
            Mode   udp
            Syslog_Format        rfc5424 
            Syslog_Hostname_key  clustername
            Syslog_Appname_key   level
            Syslog_Procid_key    stage
            Syslog_Message_key   requestURI
            Syslog_SD_key        user
            Syslog_SD_key        sourceIPs
            Syslog_SD_key        requestObject
            Syslog_SD_key        responseObject
            Syslog_SD_key        status
            Syslog_SD_key        verb
            Syslog_SD_key        userAgent
            Syslog_SD_key        responseStatus
            Syslog_SD_key        annotations
          [OUTPUT]
            Name   syslog
            Match  kube_audit.*
            Host   odcqdrvip02.warroyocorp.com
            Port   514
            Mode   udp
            Syslog_Format        rfc5424 
            Syslog_Hostname_key  clustername
            Syslog_Appname_key   level
            Syslog_Procid_key    stage
            Syslog_Message_key   requestURI
            Syslog_SD_key        user
            Syslog_SD_key        sourceIPs
            Syslog_SD_key        requestObject
            Syslog_SD_key        responseObject
            Syslog_SD_key        status
            Syslog_SD_key        verb
            Syslog_SD_key        userAgent
            Syslog_SD_key        responseStatus
            Syslog_SD_key        annotations
          [OUTPUT]
            Name   stdout
            Match  *
        inputs: |
          [INPUT]
            Name              tail
            Tag               kube.*
            Path              /var/log/containers/*.log
            Exclude_Path      /var/log/containers/fluent-bit-*
            Parser            cri
            DB                /var/log/flb_kube.db
            Mem_Buf_Limit     5MB
            Skip_Long_Lines   On
            Refresh_Interval  10
          [INPUT]
            Name                systemd
            Tag                 kube_systemd.*
            Path                /var/log/journal
            DB                  /var/log/flb_kube_systemd.db
            Systemd_Filter      _SYSTEMD_UNIT=kubelet.service
            Systemd_Filter      _SYSTEMD_UNIT=containerd.service
            Read_From_Tail      On
            Strip_Underscores   On
          [INPUT]
            Name                tail
            Tag                 kube_audit.*
            Path                /var/log/kubernetes/audit.log
            DB                  /var/log/kube_audit.db
            Parser              k8saudit
            Mem_Buf_Limit       5MB
            Skip_Long_Lines     On
            Refresh_Interval    10
        filters: |
          [FILTER]
            Name                kubernetes
            Match               kube.*
            Kube_URL            https://kubernetes.default.svc:443
            Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
            Kube_Tag_Prefix     kube.var.log.containers.
            Merge_Log           On
            Merge_Log_Key       log_processed
            K8S-Logging.Parser  On
            K8S-Logging.Exclude On
          [FILTER]
            Name            rewrite_tag
            Match           kube.*
            Rule            $kubernetes['namespace_name'] ^((cpservice-annotator-system)|(gatekeeper-system)|(csg-logging)|(harbor)|(istio-system)|(sonobuoy)|(tanzu-build-service)|(tanzu-connectivity)|(tkg-system-networking)|(vmware-system-tsm)|(build-service)|(capi-kubeadm-bootstrap-system)|(capi-kubeadm-control-plane-system)|(capi-system)|(capi-webhook-system)|(capv-system)|(stacks-operator-system)|(tanzu-system-logging)|(tkg-system-telemetry)|(tanzu-system-ingress)|(tanzu-system-registry)|(tanzu-system-connectivity)|(tanzu-system-auth)|(avi-system)|(cert-manager)|(pinniped-concierge)|(pinniped-supervisor)|(tanzu-observability-saas)|(tkg-system)|(vmware-system-tmc)|(kube-node-lease)|(kube-system))$ infra.$TAG false
          [FILTER]
            Name            record_modifier
            Match           *
            Record          clustername "${cluster_name}"
            Record          environment nonprod
          [FILTER]
            Name            grep
            Match           kube_audit.*
            Exclude         $level ^Metadata$
          [FILTER]
            Name            record_modifier
            Match           kube_audit.*
            Remove_Key      managedFields
          [FILTER]
            Name            parser
        parsers: |
          [PARSER]
            Name k8saudit
            Format json
            Time_Key requestReceivedTimestamp
            Time_format %Y-%M-%dT%T
          [PARSER]
            Name   apache
            Format regex
            Regex  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
            Time_Key time
            Time_Format %d/%b/%Y:%H:%M:%S %z
          [PARSER]
            Name   apache2
            Format regex
            Regex  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^ ]*) +\S*)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
            Time_Key time
            Time_Format %d/%b/%Y:%H:%M:%S %z
          [PARSER]
            Name   apache_error
            Format regex
            Regex  ^\[[^ ]* (?<time>[^\]]*)\] \[(?<level>[^\]]*)\](?: \[pid (?<pid>[^\]]*)\])?( \[client (?<client>[^\]]*)\])? (?<message>.*)$
          [PARSER]
            Name   nginx
            Format regex
            Regex ^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
            Time_Key time
            Time_Format %d/%b/%Y:%H:%M:%S %z
          [PARSER]
            Name   json
            Format json
            Time_Key time
            Time_Format %d/%b/%Y:%H:%M:%S %z
          [PARSER]
            Name        docker
            Format      json
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%S.%L
            Time_Keep   On
          [PARSER]
            Name        docker-daemon
            Format      regex
            Regex       time="(?<time>[^ ]*)" level=(?<level>[^ ]*) msg="(?<msg>[^ ].*)"
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%S.%L
            Time_Keep   On
          [PARSER]
            Name cri
            Format regex
            Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%S.%L%z
          [PARSER]
            Name        logfmt
            Format      logfmt
          [PARSER]
            Name        syslog-rfc5424
            Format      regex
            Regex       ^\<(?<pri>[0-9]{1,5})\>1 (?<time>[^ ]+) (?<host>[^ ]+) (?<ident>[^ ]+) (?<pid>[-0-9]+) (?<msgid>[^ ]+) (?<extradata>(\[(.*)\]|-)) (?<message>.+)$
            Time_Key    time
            Time_Format %Y-%m-%dT%H:%M:%S.%L
            Time_Keep   On
          [PARSER]
            Name        syslog-rfc3164-local
            Format      regex
            Regex       ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
            Time_Key    time
            Time_Format %b %d %H:%M:%S
            Time_Keep   On
          [PARSER]
            Name        syslog-rfc3164
            Format      regex
            Regex       /^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$/
            Time_Key    time
            Time_Format %b %d %H:%M:%S
            Time_Format %Y-%m-%dT%H:%M:%S.%L
            Time_Keep   On
          [PARSER]
            Name    kube-custom
            Format  regex
            Regex   (?<tag>[^.]+)?\.?(?<pod_name>[a-z0-9](?:[-a-z0-9]*[a-z0-9])?(?:\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*)_(?<namespace_name>[^_]+)_(?<container_name>.+)-(?<docker_id>[a-z0-9]{64})\.log$
        streams: ""
        plugins: ""
      daemonset:
        resources: { }
        podAnnotations: { }
        podLabels: { }
    
